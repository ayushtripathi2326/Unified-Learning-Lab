## Goal

Deploy the Unified-Learning-Lab project (React SPA + Node/Express API + MongoDB) to Azure Web App Service via `azd` with production-ready observability and configuration.

## Project Information

- **Repo Structure**: `frontend/` (React SPA), `backend/` (Express REST API, Vitest), shared templates/data files.
- **Technology Stack**: Node.js 20 LTS, React 18, Express 4, MongoDB driver via Mongoose.
- **Application Model**: Separate frontend SPA consuming backend REST API; JWT auth with refresh tokens; email notifications; rate limiting.
- **Current Config**: Environment variables loaded via `.env`; expects MongoDB-compatible connection string; assumes distinct origins for CORS.
- **Deployment Considerations**:
  - Build frontend once and serve static assets in an Azure Web App (Linux, Node runtime) or migrate to Azure Static Web Apps later.
  - Provision managed Mongo-compatible database (Azure Cosmos DB with Mongo API) to replace local MongoDB default.
  - Store secrets (JWT keys, email creds, Cosmos connection string) in App Service configuration or Azure Key Vault.

## Azure Resources Architecture

```mermaid
graph LR
    user((Users)) --> frontend[Azure Web App<br/>Frontend SPA]
    frontend --> backend[Azure Web App<br/>Express API]
    backend --> cosmos[Azure Cosmos DB<br/>Mongo API]
    backend --> insights[Application Insights]
    insights --> loganalytics[Log Analytics Workspace]
```

- Browser hits the frontend App Service, which serves compiled React assets.
- SPA calls the backend App Service via HTTPS.
- Backend reads/writes quiz data through Cosmos DB (Mongo API connection string).
- Application Insights collects telemetry and streams to Log Analytics for centralized monitoring.

## Recommended Azure Resources

### Application Workloads

- **Unified-Learning-Lab-frontend**

  - Hosting Service Type: Azure Web App for Linux
  - SKU: Basic B1 (1.75 GB RAM, 1 core)
  - Configuration:
    - language: nodejs
    - Environment Variables:
      - `REACT_APP_API_BASE_URL` → Backend HTTPS endpoint
  - Deployment Notes: configure App Service build command (`npm install && npm run build`) and custom startup (`npx serve -s build -l 8080`) or switch to Azure Static Web Apps if preferred later.

- **Unified-Learning-Lab-backend**
  - Hosting Service Type: Azure Web App for Linux
  - SKU: Standard S1 (autoscale readiness, 1.75 GB RAM, custom domains/SSL)
  - Configuration:
    - language: nodejs
    - Environment Variables:
      - `NODE_ENV=production`
      - `PORT=8080`
      - `MONGODB_URI` → Cosmos DB connection string
      - `JWT_SECRET`, `JWT_REFRESH_SECRET`, `JWT_EXPIRE`, `JWT_REFRESH_EXPIRE`
      - `CORS_ORIGIN` → Frontend HTTPS origin
      - `COOKIE_EXPIRE`
      - `EMAIL_HOST`, `EMAIL_PORT`, `EMAIL_USER`, `EMAIL_PASS`, `EMAIL_FROM`
      - `FRONTEND_URL` → Frontend HTTPS origin
  - Startup Command: `npm install && npm run build` (if build step exists) followed by `npm run start` (ensure `start` script exists or add `node src/server.js`).

### Dependency Resources

- **Unified-Learning-Lab-cosmos**
  - Service Type: Azure Cosmos DB (MongoDB API)
  - SKU: Autoscale throughput (e.g., 400-4000 RU/s) to handle bursty quiz workloads
  - Connection Type: Connection string stored in App Service settings (consider Key Vault later)
  - Environment Variables: `MONGODB_URI`

### Supporting Services

- **Unified-Learning-Lab-appinsights**: Application Insights (Node.js auto-collection via SDK or extension)
- **Unified-Learning-Lab-logs**: Log Analytics Workspace (linked to Application Insights)
- **Unified-Learning-Lab-keyvault** (optional now, recommended later): store secrets; allow SDK or App Service managed identity access.

## Execution Steps

1. **Infrastructure & Deployment (with `azd`)**
   1. Use `mcp_azure_mcp_deploy` → `iac-rules-get` for detailed Bicep standards.
   2. Scaffold infra under `infra/` (Bicep) describing resource group, two App Services (Linux plan), Cosmos DB, Application Insights, Log Analytics, optional Key Vault.
   3. Add `azure.yaml` describing two services (frontend, backend) with hooks for build/deploy commands.
   4. Validate Bicep syntax via `azd provisioning` or `az deployment group what-if` before actual deployment.
   5. Run `azd env new <env-name>` and populate environment values (resource group name, location, secrets).
   6. Execute `azd provision --preview`; review output, then `azd up` to provision and deploy code.
   7. Post-deploy, run `azd monitor browse` or check Application Insights logs to confirm healthy status.
2. **Post Deployment Summary**
   - Document deployed resources, connection details, and next actions in `.azure/summary.copilotmd` after successful deployment.
